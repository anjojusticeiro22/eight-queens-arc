<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>8-Queens NFT Game</title>
<style>
body { font-family: Arial; padding:20px; }
#board { display:grid; grid-template-columns:repeat(8,48px); gap:4px; margin-top:12px; }
.cell { width:48px; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid #333; }
.queen { font-size:24px; }
.invalid { background:#ff9999; cursor:not-allowed; }
button { margin-top:12px; padding:6px 12px; cursor:pointer; }
#status { margin-top:12px; }
</style>
</head>
<body>

<h1>8-Queens NFT Game</h1>
<div>Movimentos: <span id="moves">0</span></div>
<div id="board"></div>
<button id="resetBtn">Reset</button>
<button id="mintBtn" style="display:none;">Mint NFT do Score</button>
<div id="status"></div>

<!-- ethers.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<script>
// === Configura√ß√µes do contrato ===
const CONTRACT_ADDRESS = "0xf3949fff894A433dCC2BCf6D638110c54C1DbF5E";
const CONTRACT_ABI = [
    "function mintScore(string memory tokenURI) public returns (uint256)"
];

// === Vari√°veis do tabuleiro ===
let board = Array(8).fill(-1);
let moves = 0;
const boardEl = document.getElementById('board');
const movesEl = document.getElementById('moves');
const statusEl = document.getElementById('status');
const mintBtn = document.getElementById('mintBtn');

// Checa se uma c√©lula est√° atacada
function isAttacked(r, c) {
    for (let i = 0; i < 8; i++) {
        if (board[i] === -1) continue;
        let qr = i, qc = board[i];
        if (r === qr || c === qc) return true;
        if (Math.abs(r - qr) === Math.abs(c - qc)) return true;
    }
    return false;
}

// Checa se todas as rainhas foram colocadas
function allQueensPlaced() {
    return board.every(col => col !== -1);
}

// Renderiza o tabuleiro
function renderBoard() {
    boardEl.innerHTML = '';
    for (let r=0; r<8; r++) {
        for (let c=0; c<8; c++) {
            const div = document.createElement('div');
            div.className = 'cell';
            div.dataset.r = r; div.dataset.c = c;

            if (board[r] === c) {
                const span = document.createElement('span');
                span.className = 'queen';
                span.textContent = '‚ôï';
                div.appendChild(span);
            }

            if (isAttacked(r, c) && board[r] !== c) div.classList.add('invalid');

            div.onclick = () => {
                if (isAttacked(r, c) && board[r] !== c) return;
                board[r] === c ? board[r] = -1 : board[r] = c;
                moves++;
                movesEl.textContent = moves;
                renderBoard();
            };

            boardEl.appendChild(div);
        }
    }

    // Bloqueia ou mostra o bot√£o Mint
    mintBtn.style.display = allQueensPlaced() ? 'inline-block' : 'none';
}

// Reset
document.getElementById('resetBtn').onclick = () => {
    board.fill(-1);
    moves = 0;
    movesEl.textContent = moves;
    renderBoard();
};

// Inicializa tabuleiro
renderBoard();

// Fun√ß√£o mint NFT
mintBtn.onclick = async () => {
    try {
        if (!window.ethereum) { alert("Instale MetaMask ou Rabby"); return; }

        // Conecta carteira
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();

        // Contrato com signer para for√ßar assinatura
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // tokenURI com score
        const tokenURI = JSON.stringify({ moves: moves, timestamp: Date.now() });

        statusEl.textContent = 'üìù Abrindo assinatura para mint...';

        // Chama mintScore COM assinatura
        const tx = await contract.mintScore(tokenURI, { gasLimit: 100000 });

        statusEl.textContent = `üí≥ Transa√ß√£o enviada: ${tx.hash}`;

        const receipt = await tx.wait();
        statusEl.textContent = `‚úÖ NFT Mintado no bloco ${receipt.blockNumber}`;
    } catch(err) {
        console.error(err);
        statusEl.textContent = `‚ùå Erro: ${err.message || err}`;
    }
};
</script>
</body>
</html>
